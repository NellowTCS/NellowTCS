name: Generate GitHub Snake (gradient)

on:
  workflow_dispatch:
  schedule:
    - cron: '0 6 * * *' # daily at 06:00 UTC — change or remove if you don't want a schedule

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate SVG (svg-only)
        uses: Platane/snk/svg-only@v3
        with:
          # github user name to read the contribution graph from
          github_user_name: NellowTCS
          # output path; set the snake color to the left gradient stop so we can find/replace it later
          outputs: |
            dist/github-snake.svg?color_snake=#2196F3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Patch SVG to use linear gradient
        run: |
          python - <<'PY'
          from pathlib import Path
          import re

          svg_path = Path('dist/github-snake.svg')
          if not svg_path.exists():
              print("Error: dist/github-snake.svg not found")
              raise SystemExit(1)

          s = svg_path.read_text(encoding='utf-8')

          # Prepare gradient defs
          grad_id = "snakeGradient"
          gradient_defs = f'''
  <defs>
    <linearGradient id="{grad_id}" x1="0%" y1="0%" x2="100%" y2="0%">
      <stop offset="0%" stop-color="#2196F3"/>
      <stop offset="100%" stop-color="#21CBF3"/>
    </linearGradient>
  </defs>
'''

          # Insert gradient defs right after the opening <svg ...> tag
          m = re.search(r'(<svg\b[^>]*>)', s, flags=re.IGNORECASE)
          if m:
              s = s.replace(m.group(1), m.group(1) + gradient_defs, 1)
              print("Inserted gradient <defs> after <svg> tag.")
          else:
              print("Warning: <svg> tag not found — skipping defs injection.")

          # Replace the snake color occurrences with gradient reference.
          # We generated the SVG with color_snake=#2196F3, so target that exact string.
          s_new = s.replace('fill="#2196F3"', f'fill="url(#{grad_id})"')
          s_new = s_new.replace("fill='#2196F3'", f'fill="url(#{grad_id})"')
          s_new = s_new.replace('stroke="#2196F3"', f'stroke="url(#{grad_id})"')
          s_new = s_new.replace("stroke='#2196F3'", f'stroke="url(#{grad_id})"')

          if s_new == s:
              print("No direct occurrences of #2196F3 found for replacement. (The SVG might use inline styles or different hex).")
              # Try replacing occurrences inside style="" attributes (e.g., style="fill:#2196F3;")
              s_new = re.sub(r'(?i)fill:\s*#2196F3', f'fill:url(#{grad_id})', s_new)
              s_new = re.sub(r'(?i)stroke:\s*#2196F3', f'stroke:url(#{grad_id})', s_new)

          # Overwrite file
          svg_path.write_text(s_new, encoding='utf-8')
          print("Patched SVG to use gradient.")
          PY

      - name: Show a preview snippet (first 40 lines)
        run: |
          echo "---- preview ----"
          sed -n '1,40p' dist/github-snake.svg || true
          echo "---- end preview ----"

      - name: Commit and push generated SVG
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add dist/github-snake.svg
          git commit -m "chore: generate github-snake.svg with gradient" || echo "no changes to commit"
          git push || echo "push failed (maybe read-only token)"
