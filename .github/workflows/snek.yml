name: Generate GitHub Snek (gradient)

on:
  workflow_dispatch:
  schedule:
    - cron: '0 6 * * *' # daily at 06:00 UTC — change or remove if you don't want a schedule

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate SVG (svg-only)
        uses: Platane/snk/svg-only@v3
        with:
          # github user name to read the contribution graph from
          github_user_name: NellowTCS
          # outputs is a multiline string; keep the pipe and indent exactly as shown
          outputs: |
            dist/github-snake.svg?color_snake=#2196F3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Patch SVG to use linear gradient
        run: |
          python - <<'PY'
          from pathlib import Path
          import re

          svg_path = Path('dist/github-snake.svg')
          if not svg_path.exists():
              print("Error: dist/github-snake.svg not found")
              raise SystemExit(1)

          s = svg_path.read_text(encoding='utf-8')

          grad_id = "snakeGradient"
          # Build the SVG defs using concatenated string
          gradient_defs = (
              '<defs>\n'
              '  <linearGradient id="' + grad_id + '" x1="0%" y1="0%" x2="100%" y2="0%">\n'
              '    <stop offset="0%" stop-color="#2196F3"/>\n'
              '    <stop offset="100%" stop-color="#21CBF3"/>\n'
              '  </linearGradient>\n'
              '</defs>\n'
          )

          # Insert gradient defs right after the opening <svg ...> tag
          m = re.search(r'(<svg\b[^>]*>)', s, flags=re.IGNORECASE)
          if m:
              s = s.replace(m.group(1), m.group(1) + gradient_defs, 1)
              print("Inserted gradient <defs> after <svg> tag.")
          else:
              print("Warning: <svg> tag not found — skipping defs injection.")

          # Replace the snake color occurrences with gradient reference.
          # We generated the SVG with color_snake=#2196F3, so target that exact string.
          s_new = s.replace('fill="#2196F3"', f'fill="url(#{grad_id})"')
          s_new = s_new.replace("fill='#2196F3'", f'fill="url(#{grad_id})"')
          s_new = s_new.replace('stroke="#2196F3"', f'stroke="url(#{grad_id})"')
          s_new = s_new.replace("stroke='#2196F3'", f'stroke="url(#{grad_id})"')

          if s_new == s:
              # fallback: try matching inside style attributes like style="fill:#2196F3;"
              s_new = re.sub(r'(?i)fill:\s*#2196F3', f'fill:url(#{grad_id})', s_new)
              s_new = re.sub(r'(?i)stroke:\s*#2196F3', f'stroke:url(#{grad_id})', s_new)

          svg_path.write_text(s_new, encoding='utf-8')
          print("Patched SVG to use gradient.")
          PY

      - name: Commit and push generated SVG
        env:
          GIT_AUTHOR_NAME: "github-actions[bot]"
          GIT_AUTHOR_EMAIL: "41898282+github-actions[bot]@users.noreply.github.com"
        run: |
          git config user.name "${GIT_AUTHOR_NAME}"
          git config user.email "${GIT_AUTHOR_EMAIL}"
          git add dist/github-snake.svg
          git commit -m "chore: generate github-snake.svg with gradient" || echo "no changes to commit"
          git push || echo "push failed (maybe read-only token)"